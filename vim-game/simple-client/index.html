<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ VimGame - Learn YOUR Shortcuts!</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Monaco', 'Consolas', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 20px;
        }
        .header h1 {
            color: #4CAF50;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #aaa;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .game-area {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }
        .vim-simulator {
            flex: 1;
            background: #1e1e1e;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            font-family: monospace;
            position: relative;
        }
        .lesson-panel {
            width: 350px;
            background: #252525;
            border-radius: 8px;
            padding: 20px;
        }
        .lesson-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .lesson-item {
            background: #333;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            border-left: 4px solid #4CAF50;
            transition: all 0.3s ease;
        }
        .lesson-item:hover {
            background: #404040;
            transform: translateX(5px);
        }
        .lesson-item h3 {
            margin: 0 0 8px 0;
            color: #4CAF50;
            font-size: 1.1em;
        }
        .lesson-item p {
            margin: 0;
            color: #ccc;
            font-size: 0.9em;
        }
        .lesson-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8em;
            color: #888;
        }
        .current-lesson {
            margin-bottom: 20px;
            padding: 15px;
            background: #2a4d3a;
            border-radius: 6px;
        }
        .current-lesson h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .challenge-text {
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        .hint-text {
            color: #ffa726;
            font-style: italic;
            margin-top: 10px;
        }
        .score {
            text-align: center;
            background: #1a4d1a;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .score h3 {
            margin: 0;
            color: #4CAF50;
            font-size: 1.5em;
        }
        .command-input {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #333;
            border: 1px solid #4CAF50;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .message {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }
        .message.success {
            background: #2d5a2d;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        .message.error {
            background: #5a2d2d;
            color: #f44336;
            border: 1px solid #f44336;
        }
        #lesson-content {
            margin-top: 60px;
        }
        .vim-buffer {
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            min-height: 200px;
            border: 1px solid #333;
            margin-bottom: 60px;
        }
        .status-line {
            position: absolute;
            bottom: 50px;
            left: 20px;
            right: 20px;
            background: #4CAF50;
            color: #000;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .shortcut-key {
            background: #4CAF50;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ VimGame</h1>
            <p>Learn YOUR JetBrains-style Space+1-8 shortcuts!</p>
        </div>

        <div class="game-area">
            <div class="vim-simulator">
                <div class="message" id="message"></div>
                
                <div id="lesson-content">
                    <h2>Welcome to VimGame! üöÄ</h2>
                    <p>This interactive game teaches you the <strong>actual keybindings</strong> you've configured in your Neovim setup.</p>
                    <p>Select a lesson from the panel on the right to start learning your Space+1-8 shortcuts!</p>
                    <br>
                    <div class="vim-buffer">
// Welcome to YOUR Neovim config!
// Let's learn the bindings you've set up

function main() {
  console.log('Your JetBrains-style shortcuts:');
  console.log('Space+1 = üìÅ File Explorer');
  console.log('Space+2 = üîÄ Git Status');
  console.log('Space+8 = üíª Terminal');
  console.log('Press a lesson to start!');
}
                    </div>
                </div>

                <div class="status-line">-- NORMAL -- Ready to learn your shortcuts!</div>
                <input type="text" class="command-input" id="commandInput" placeholder="Press keys here..." style="display: none;">
            </div>

            <div class="lesson-panel">
                <div class="score">
                    <h3 id="scoreDisplay">Score: 0</h3>
                </div>

                <div class="current-lesson" id="currentLesson" style="display: none;">
                    <h3 id="lessonTitle">No lesson selected</h3>
                    <div class="challenge-text" id="challengeText"></div>
                    <div class="hint-text" id="hintText"></div>
                </div>

                <div class="lesson-list" id="lessonList">
                    <div class="lesson-item">
                        <h3>Loading lessons...</h3>
                        <p>Fetching your personalized curriculum...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentLesson = null;
        let score = 0;

        // DOM elements
        const messageEl = document.getElementById('message');
        const lessonListEl = document.getElementById('lessonList');
        const currentLessonEl = document.getElementById('currentLesson');
        const lessonTitleEl = document.getElementById('lessonTitle');
        const challengeTextEl = document.getElementById('challengeText');
        const hintTextEl = document.getElementById('hintText');
        const scoreDisplayEl = document.getElementById('scoreDisplay');
        const commandInputEl = document.getElementById('commandInput');
        const lessonContentEl = document.getElementById('lesson-content');

        // Utility functions
        function showMessage(text, type = 'success') {
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        function updateScore(newScore) {
            score = newScore;
            scoreDisplayEl.textContent = `Score: ${score}`;
        }

        // Load lessons
        fetch('/api/lessons')
            .then(res => res.json())
            .then(lessons => {
                lessonListEl.innerHTML = '';
                lessons.forEach(lesson => {
                    const lessonEl = document.createElement('div');
                    lessonEl.className = 'lesson-item';
                    lessonEl.innerHTML = `
                        <h3>${lesson.title}</h3>
                        <p>${lesson.description}</p>
                        <div class="lesson-meta">
                            <span>üìä ${lesson.difficulty}</span>
                            <span>‚≠ê ${lesson.points} pts</span>
                            <span>‚è±Ô∏è ${lesson.estimated_time}min</span>
                        </div>
                    `;
                    lessonEl.addEventListener('click', () => startLesson(lesson.id));
                    lessonListEl.appendChild(lessonEl);
                });
            })
            .catch(err => {
                console.error('Failed to load lessons:', err);
                lessonListEl.innerHTML = '<div class="lesson-item"><h3>‚ùå Failed to load lessons</h3><p>Check if the server is running</p></div>';
            });

        // Start a lesson
        function startLesson(lessonId) {
            socket.emit('start_lesson', lessonId);
            commandInputEl.style.display = 'block';
            commandInputEl.focus();
        }

        // Handle keyboard input
        let waitingForLeaderCombo = false;
        
        commandInputEl.addEventListener('keydown', (e) => {
            // Skip processing if we're waiting for a leader combination
            if (waitingForLeaderCombo) {
                return;
            }
            
            // Convert key combinations to vim notation
            let command = '';
            
            if (e.key === ' ') {
                // Handle Space as leader key - wait for next key
                e.preventDefault();
                waitingForLeaderCombo = true;
                
                const handleLeaderCombo = (nextE) => {
                    nextE.preventDefault();
                    commandInputEl.removeEventListener('keydown', handleLeaderCombo);
                    
                    if (nextE.key >= '1' && nextE.key <= '8') {
                        // Leader combination
                        waitingForLeaderCombo = false;
                        command = `<leader>${nextE.key}`;
                        socket.emit('vim_command', command);
                        commandInputEl.value = '';
                    } else if (nextE.key === 't') {
                        // Handle <leader>t combinations for testing
                        // Wait for one more key (keep waitingForLeaderCombo = true)
                        const handleTestCombo = (testE) => {
                            testE.preventDefault();
                            commandInputEl.removeEventListener('keydown', handleTestCombo);
                            waitingForLeaderCombo = false;
                            
                            if (testE.key === 't') {
                                socket.emit('vim_command', '<leader>tt');
                            } else if (testE.key === 'f') {
                                socket.emit('vim_command', '<leader>tf');
                            } else if (testE.key === 'o') {
                                socket.emit('vim_command', '<leader>to');
                            } else if (testE.key === 's') {
                                socket.emit('vim_command', '<leader>ts');
                            } else {
                                // Not a recognized test combo, send leader+t then the key
                                socket.emit('vim_command', '<leader>t');
                                setTimeout(() => {
                                    if (testE.key.length === 1) {
                                        socket.emit('vim_command', testE.key);
                                    }
                                }, 10);
                            }
                            commandInputEl.value = '';
                        };
                        commandInputEl.addEventListener('keydown', handleTestCombo);
                        return;
                    } else {
                        // Not a leader combination - send space then the key
                        waitingForLeaderCombo = false;
                        socket.emit('vim_command', '<Space>');
                        commandInputEl.value = '';
                        // Let the key be processed normally by not preventing it
                        setTimeout(() => {
                            if (nextE.key.length === 1) {
                                socket.emit('vim_command', nextE.key);
                            }
                        }, 10);
                    }
                };
                commandInputEl.addEventListener('keydown', handleLeaderCombo);
                return;
            } else if (e.key.length === 1) {
                if (e.ctrlKey) command = `<C-${e.key.toLowerCase()}>`;
                else if (e.shiftKey) command = e.key;
                else command = e.key;
            } else if (e.key === 'Enter') {
                command = '<CR>';
            } else if (e.key === 'Escape') {
                command = '<Esc>';
            } else if (e.key.startsWith('F')) {
                if (e.shiftKey) {
                    command = `<S-${e.key}>`;
                } else {
                    command = `<${e.key}>`;
                }
            }


            if (command) {
                socket.emit('vim_command', command);
                commandInputEl.value = '';
                e.preventDefault();
            }
        });

        // Socket event handlers
        socket.on('lesson_started', (data) => {
            currentLesson = data.lesson;
            currentLessonEl.style.display = 'block';
            lessonTitleEl.textContent = data.lesson.title;
            
            if (data.challenge) {
                challengeTextEl.textContent = data.challenge.description;
                if (data.challenge.hints && data.challenge.hints.length > 0) {
                    hintTextEl.textContent = `üí° ${data.challenge.hints[0].text}`;
                }
            }

            // Update vim buffer with lesson content
            if (data.challenge.initial_state && data.challenge.initial_state.buffer) {
                const bufferContent = data.challenge.initial_state.buffer.join('\n');
                lessonContentEl.innerHTML = `
                    <div class="vim-buffer">${bufferContent}</div>
                `;
            }

            showMessage(`üöÄ Started: ${data.lesson.title}`, 'success');
        });

        socket.on('command_result', (data) => {
            showMessage(data.message, data.success ? 'success' : 'error');
            updateScore(data.score);
        });

        socket.on('next_challenge', (data) => {
            challengeTextEl.textContent = data.challenge.description;
            if (data.challenge.hints && data.challenge.hints.length > 0) {
                hintTextEl.textContent = `üí° ${data.challenge.hints[0].text}`;
            }
            
            // Update buffer if needed
            if (data.challenge.initial_state && data.challenge.initial_state.buffer) {
                const bufferContent = data.challenge.initial_state.buffer.join('\n');
                lessonContentEl.innerHTML = `
                    <div class="vim-buffer">${bufferContent}</div>
                `;
            }
        });

        socket.on('lesson_completed', (data) => {
            showMessage(`üéâ Lesson completed! Final score: ${data.totalScore}`, 'success');
            currentLessonEl.style.display = 'none';
            commandInputEl.style.display = 'none';
            
            lessonContentEl.innerHTML = `
                <h2>üéâ Lesson Completed!</h2>
                <p><strong>Final Score:</strong> ${data.totalScore} points</p>
                <p><strong>Time:</strong> ${Math.round(data.timeSpent / 1000)} seconds</p>
                <p>Great job learning your Space+1-8 shortcuts! Select another lesson to continue.</p>
            `;
        });

        // Initial focus
        setTimeout(() => {
            if (commandInputEl.style.display !== 'none') {
                commandInputEl.focus();
            }
        }, 1000);
    </script>
</body>
</html>